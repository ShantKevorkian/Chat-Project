# TranslationOS GitHub connector

This repo contains the code of the connector between the TranslationOS APIs and GitHub.
The connector is a GitHub application that may be installed on a repo and performs intake and deliveries of translated content
from/to it.

## Local development

To develop the GitHub connector you should:

1. Register to a webhook interception platform like [Hookdeck](https://hookdeck.io), [Smee](https://smee.io)
   or [Ngrok](https://ngrok.io) and launch their tunnel cli locally.
2. Register to [Beeceptor](https://beeceptor.com) and activate an endpoint
3. Make a registration of a test GitHub application following the instructions below and:
   * point the Setup URL to the Beeceptor endpoint
   * point the Webhook URL to the public URL provided by the interception platform
4. Copy the `.env.example` file to `.env` in your cloned repo (this file is ignored by default) and insert the needed values
   returned/generated by GitHub in the above step.
5. Launch `yarn serve`
6. Add the GitHub application to a user/organization account and authorize it on some repos
7. Make some commits in the repo


## Environments

* `staging` deployed on Translated staging Docker Swarm automatically at every commit by CI/CD pipeline, interfaces with TOS API
  staging environment.
* `sandbox` deployed on Translated production Docker Swarm automatically at every commit by CI/CD pipeline, interfaces with TOS
  API sandbox environment.
* `production` deployed on Translated production Docker Swarm automatically at every commit by CI/CD pipeline, interfaces with TOS
  API production environment.

## Manual registration of the Connector GitHub App in Translated organization

Perform the following steps for registering the production application on GitHub (similar steps can be followed to register a test
application pointing to the staging environment and a test application for local development):

1. Go to Translated organization account settings
2. In the bottom left corner, click on **Developer Settings**
3. Then click on **GitHub Apps**
4. On the right corner, click **New GitHub App**
5. Fill the form with the following values:
    - GitHub App name: `TranslationOS GitHub Connector`
    - Description (this is displayed to users): `TranslationOS <> GitHub connector`
    - Homepage URL (required): `https://tos-connector-github.translated.com`
    - Setup URL: `https://tos-connector-github.translated.com/setup`
    - Check `Redirect on update`
    - Check `Active` in Webhook section
    - Webhook URL (events such as push, pull etc... will post to this
      URL): `https://tos-connector-github.staging.translated.com/webhook`
    - Webhook secret: `tr4nsl4t3d`
    - Leave SSL verification enabled
6. Fill the following permissions:
    - Repository section
        - Commit statuses: Read and write
        - Contents: Read and write
        - Issues: Read and write
        - Metadata: Read only
        - Pull requests: Read and write
        - Secrets: Read only
        - Webhooks: Read and write
    - Organization section
        - Secrets: Read only
    - User section
        - Email addresses: Read only
7. Check to subscribe to the following events:
    - Push
8. Click on **Create**
9. Copy the `App ID` and `Client ID` values into the appropriate environment vars in the `.env.production` file
10. Click on `Generate new client secret` button
11. Copy the generated secret into the appropriate environment var in the `.env.production` file
12. Click on `Generate private key` button
13. Open the downloaded `pem` file and copy the whole content into the appropriate environment var in the `.env.production` file

## GitHub App with the manifest flow

We can always create an app with the manifest flow. Meaning there will be a pre-configured file with all the settings needed to
create
the GitHub app (instead of using the GitHub UI).
We should trigger a post request to `https://github.com/settings/apps/new` providing a JSON manifest configuration file (located
in the `src/manifest-flow/manifest.json`).
After creating the app with the manifest flow, GitHub will redirect to your site to the specified redirected URL with a temporary
code.
Then we can use the API app manifest (`https://api.github.com/app-manifests/CODE/conversions`) replacing `CODE` with the temporary
code provided from GitHub. That should return a response providing the needed app configuraion file that should be stored
in `.env` file (client_id, client_secret, webhook_secret, pem).
